---
title: "child"
author: "sl team"
date: "4/26/2020"
output: html_document
---

```{r, echo = FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
my_subset <- filter(my_vars, family == families[k] & !is.na(variable))

if (!is.null(my_blog)){
  blog_aggregate <- filter(my_blog, family == families[k] & !is.na(entry_aggregates))
  blog_disaggregate <- filter(my_blog, family == families[k] & !is.na(entry_disaggregates))
}else {
  blog_aggregate <- NULL
  blog_disaggregate <- NULL
}



```


## `r gsub("_", " ", families[k])`  {.tabset  .tabset-pills}


***


### Aggregates

```{r, echo = FALSE}
daily <- (isTRUE("daily" %in% trend) & !isTRUE("moving_average"%in% trend))
mov_average <- (!isTRUE("daily" %in% trend) & isTRUE("moving_average"%in% trend))
both <- (isTRUE("daily" %in% trend) & isTRUE("moving_average"%in% trend))
aggregate <-  (isTRUE("aggregate" %in% trend))
```

#### Aggregates in Kampala

```{asis, echo = TRUE, eval= !is.null(blog_aggregate) && nrow(blog_aggregate)!=0, code=blog_aggregate$entry_aggregates}
```

```{r, eval=(daily|both), echo = FALSE, fig.cap="Average responses for a given day (dot) with 95% confidence intervals (whiskers)", message = FALSE, warning = FALSE}
plot_aggregates(my_data, my_subset, pd = pd, switch = switch)
```

```{r, eval=(mov_average|both), echo = FALSE, fig.cap="3 day moving average with 95% confidence intervals", fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE}
plot_mov_avg(my_data, my_subset, pd = pd, switch = switch)
```

```{r, eval=(aggregate) && nrow(my_subset)==2 && my_subset$family[[1]]!="Actions when suspecting infection", echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=1)
```
 
```{r, eval=(aggregate) && nrow(my_subset)>=10 && my_subset$family[[1]]!="Actions when suspecting infection", echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=10)
```

```{r, eval=(aggregate) && nrow(my_subset)<10 && nrow(my_subset)>4 && my_subset$family[[1]]!="Actions when suspecting infection", echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=4)
```

```{r, eval=(aggregate) && nrow(my_subset)==4 && my_subset$family[[1]]!="Actions when suspecting infection", echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=2)
```

```{r, eval=(aggregate) && my_subset$family[[1]]=="Actions when suspecting infection", echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}


library(sjlabelled)
library(foreach)

df <- my_data

suspects <- df %>% dplyr::select(starts_with("suspects_"))  %>% names  # get varnames of suspect questions
suspects <- head(suspects,-1)  ## remove the last qs (Others)
df_susp <- data.frame(
  question = get_label(df[,suspects]),
  foreach(i=suspects,.combine="rbind") %do%{
    eachqs = df[,i]
    obs = nrow(eachqs %>% drop_na())
    yes = sum(eachqs==1)
    no = sum(eachqs==0)
    perc = round(yes/obs,3)*100
    c("observations" = obs,"Yes-1" = yes,"No-0"=no,"Perc."=perc)
  },
  stringsAsFactors = FALSE)

df_susp$question[df_susp$question == "Other Specify"] <-"Other (e.g. report to LC1/Police)" 

rownames(df_susp) <- NULL

df_susp$question=factor(df_susp$question, levels = df_susp$question[order(df_susp$Perc.)])

p_susp = ggplot(data = df_susp,aes(x=factor(question),y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() +
  geom_text(aes(label=Perc.),size=4, hjust = -0.2) +
  ylab("% of Respondents") + xlab("") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black",size=11), axis.text.y = element_text(colour="black",size=11))
p_susp 


```



### Current averages

```{r, echo = FALSE, message = FALSE}

current_means <- get_current_means(my_data, my_subset, recent = 1)

kable(current_means, caption = paste("Mean responses in each ", group, " (most recent date)"), 
        col.names = c(group, "Date", my_subset$short_label), 
        digits = 2)

```


<!-- Optionally add maps -->

```{r, child = add_mapsRmd, echo = FALSE, eval = add_maps}

```


### Definitions of measures

```{r, echo = FALSE, warning = FALSE}

if("min" %in% colnames(my_subset) & "max" %in% colnames(my_subset))
{
  my_subset %>% mutate(range = paste(as.character(min), "-", as.character(max))) %>%
    select(short_label, description, range, scale) %>% 
   kable(caption = "Data definitions", col.names = c("Measure", "Definition", "Range", "Response options"))
}else {
  my_subset %>% select(short_label, description) %>% 
  kable(caption = "Data definitions", col.names = c("Measure", "Definition"))
  }

```

```{r, include = FALSE}
k <- k+1
```

```{r, child = childRmd, echo = FALSE, eval = k <= n_families}

```
