---
title: "child"
author: "sl team"
date: "4/26/2020"
output: html_document
---

```{r, echo = FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
my_subset <- filter(my_vars, family == families[k] & !is.na(variable))

if (!is.null(my_blog)){
  blog_aggregate <- filter(my_blog, family == families[k] & !is.na(entry_aggregates))
  blog_disaggregate <- filter(my_blog, family == families[k] & !is.na(entry_disaggregates))
}else {
  blog_aggregate <- NULL
  blog_disaggregate <- NULL
}



```


## `r gsub("_", " ", families[k])`  {.tabset  .tabset-pills}

### Aggregates


```{r, eval=(my_subset$family[[1]]=="Economic situation"), echo = FALSE, fig.height = 8, fig.width=11, message = FALSE, warning = FALSE, results = 'hide'}

vars_used  <- my_subset %>% filter(!is.na(variable)) %>% pull(variable)
df <- my_data %>% select(id, date, all_of(vars_used))
to_hist <- select_if(df, is.numeric) %>% names()


histograms <- list()
for (var in to_hist) {
  
  title <- filter(my_subset, variable==var) %>% select(short_label)
  units <- filter(my_subset, variable==var) %>% select(unit)
  
  question_label <- split_every(title$short_label, 6, pattern = " ")
  question_label <- paste(question_label,collapse="\n")
  
  hist <- ggplot(df, aes_string(x=var)) + geom_histogram() + coord_flip() +
    labs(title=paste(question_label),x=paste(units), y = "Density") + 
    scale_x_continuous(labels = comma, n.breaks = 7) +
    theme(plot.title = element_text(hjust = 0.5)) + theme_minimal()
  histograms[[var]] <- hist
}

to_bar <- select_if(df, is.factor) %>% select(-id) %>% names()
my_vars_bar <- filter(my_subset, variable==to_bar)
c <- dashdash:::create_bars(my_data, my_vars_bar)

histograms <- c(histograms, c)

nrow <- 3
g <-  do.call(grid.arrange, c(histograms, list(nrow=nrow)))


```

```{r, eval=(my_subset$family[[1]]=="Knowledge and assessment"), echo = FALSE, fig.height = 5, fig.width=7, message = FALSE, warning = FALSE, results = 'hide'}

vars_used  <- my_subset %>% filter(!is.na(variable)) %>% pull(variable)
df <- my_data %>% select(id, date, all_of(vars_used))
to_hist <- select_if(df, is.numeric) %>% names()


histograms <- list()
for (var in to_hist) {

  title <- filter(my_subset, variable==var) %>% select(short_label)
  units <- filter(my_subset, variable==var) %>% select(unit)
  
  question_label <- split_every(title$short_label, 6, pattern = " ")
  question_label <- paste(question_label,collapse="\n")
  
  hist <- ggplot(df, aes_string(x=var)) + geom_histogram() + coord_flip() +
    labs(title=paste(question_label),x=paste(units), y = "Density") + 
    scale_x_continuous(labels = comma, n.breaks = 7) +
    theme(plot.title = element_text(hjust = 0.5)) + theme_minimal()
  histograms[[var]] <- hist
}

to_bar <- select_if(df, is.factor) %>% select(-id) %>% names()
my_vars_bar <- filter(my_subset, variable==to_bar)
c <- dashdash:::create_bars(my_data, my_vars_bar)

histograms <- c(histograms, c)

nrow <- 2
g <-  do.call(grid.arrange, c(histograms, list(nrow=nrow)))


```

```{r, eval=(my_subset$family[[1]]=="Food security"), echo = FALSE, fig.height = 4, fig.width=9, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::bars_together(my_data, my_subset)
```

```{r, eval=(my_subset$family[[1]]=="Prevention measures"), echo = FALSE, fig.height = 15, fig.width=16, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::bars_together(my_data, my_subset, nrow=5)
```

```{r, eval=(my_subset$family[[1]]=="Response evaluation"),  echo = FALSE, fig.height = 15, fig.width=16, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::bars_together(my_data, my_subset, nrow=3)
```

```{r, eval=(my_subset$family[[1]]=="Risk perception"), echo = FALSE, fig.height = 11, fig.width=12, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::bars_together(my_data, my_subset, nrow=5)
```

```{r, eval=(my_subset$family[[1]]=="Symptoms"), echo = FALSE, fig.height = 5, fig.width=7, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::bars_together(my_data, my_subset, nrow=2)
```

### By state

```{r, eval=(my_subset$family[[1]]=="Food security"), echo = FALSE, fig.height = 4, fig.width=9, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::het_bar_all(my_data, my_subset)
```

```{r, eval=(my_subset$family[[1]]=="Prevention measures"), echo = FALSE, fig.height = 15, fig.width=16, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::het_bar_all(my_data, my_subset, nrow=5)
```

```{r, eval=(my_subset$family[[1]]=="Response evaluation"),  echo = FALSE, fig.height = 15, fig.width=16, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::het_bar_all(my_data, my_subset, nrow=3)
```

```{r, eval=(my_subset$family[[1]]=="Risk perception"), echo = FALSE, fig.height = 10, fig.width=12, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::het_bar_all(my_data, my_subset, nrow=5)
```

```{r, eval=(my_subset$family[[1]]=="Symptoms"), echo = FALSE, fig.height = 5, fig.width=7, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::het_bar_all(my_data, my_subset, nrow=3)
```

```{r, eval=(my_subset$family[[1]]=="Economic situation"), echo = FALSE, fig.height = 7, fig.width=12, message = FALSE, warning = FALSE, results = 'hide'}
vars_used  <- my_subset %>% filter(!is.na(variable)) %>% pull(variable)
df <- my_data %>% select(id, date, all_of(vars_used))
to_hist <- select_if(df, is.numeric) %>% names()

histograms <- list()

for (var in to_hist) {
  title <- filter(my_subset, variable==var) %>% select(short_label)
  units <- filter(my_subset, variable==var) %>% select(unit)
  hist <- ggplot(df, aes_string(x=var, color="id", fill="id")) +
    geom_histogram(position="dodge")+ 
    coord_flip() +
    labs(title=paste(title),x=paste(units), y = "Density", fill = "State", color="") + 
    scale_x_continuous(labels = comma, n.breaks = 7) +
    theme(plot.title = element_text(hjust = 0.5))+ 
    theme_minimal() +
    scale_color_grey()+
    scale_fill_grey(labels = c("Delta", "Edo")) + guides(color = FALSE)
  histograms[[var]] <- hist
}

to_bar <- select_if(df, is.factor) %>% select(-id) %>% names()
my_vars_bar <- filter(my_subset, variable==to_bar)
c <- dashdash:::het_bar_plot(my_data, my_vars_bar)

histograms <- c(histograms, c)

nrow <- 3
g <-  do.call(grid.arrange, c(histograms, list(nrow=nrow)))


```


```{r, eval=(my_subset$family[[1]]=="Knowledge and assessment"), echo = FALSE, fig.height = 7, fig.width=12, message = FALSE, warning = FALSE, results = 'hide'}
vars_used  <- my_subset %>% filter(!is.na(variable)) %>% pull(variable)
df <- my_data %>% select(id, date, all_of(vars_used))
to_hist <- select_if(df, is.numeric) %>% names()

histograms <- list()

for (var in to_hist) {
  title <- filter(my_subset, variable==var) %>% select(short_label)
  units <- filter(my_subset, variable==var) %>% select(unit)
  hist <- ggplot(df, aes_string(x=var, color="id", fill="id")) +
    geom_histogram(position="dodge")+ 
    coord_flip() +
    labs(title=paste(title),x=paste(units), y = "Density", fill = "State", color="") + 
    scale_x_continuous(labels = comma, n.breaks = 7) +
    theme(plot.title = element_text(hjust = 0.5))+ 
    theme_minimal() +
    scale_color_grey()+
    scale_fill_grey(labels = c("Delta", "Edo")) + guides(color = FALSE)
  histograms[[var]] <- hist
}

to_bar <- select_if(df, is.factor) %>% select(-id) %>% names()
my_vars_bar <- filter(my_subset, variable==to_bar)
c <- dashdash:::het_bar_plot(my_data, my_vars_bar)

histograms <- c(histograms, c)

nrow <- 2
g <-  do.call(grid.arrange, c(histograms, list(nrow=nrow)))


```

### Current averages

```{r, echo = FALSE, message = FALSE}

current_means <- get_current_means(my_data, my_subset, recent = 1)


kable(current_means, caption = paste("Mean responses in each ", group, " (most recent date)"), 
        col.names = c(group, "Date", my_subset$short_label), 
        digits = 2)

```


<!-- Optionally add maps -->

```{r, child = add_mapsRmd, echo = FALSE, eval = add_maps}

```


### Definitions of measures

```{r, echo = FALSE, warning = FALSE}

if("min" %in% colnames(my_subset) & "max" %in% colnames(my_subset))
{
  my_subset %>% mutate(range = paste(as.character(min), "-", as.character(max))) %>%
    select(short_label, description, range) %>% 
   kable(caption = "Data definitions", col.names = c("Measure", "Definition", "Range"))
}else {
  my_subset %>% select(short_label, description) %>% 
  kable(caption = "Data definitions", col.names = c("Measure", "Definition"))
  }

```

```{r, include = FALSE}
k <- k+1
```

```{r, child = childRmd, echo = FALSE, eval = k <= n_families}

```
