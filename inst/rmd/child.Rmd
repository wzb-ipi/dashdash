---
title: "child"
author: "sl team"
date: "4/26/2020"
output: html_document
---

```{r, echo = FALSE}
my_subset <- filter(my_vars, family == families[k] & !is.na(variable))
```


## `r gsub("_", " ", families[k])`  {.tabset  .tabset-pills}


***


### Aggregates



#### Aggregates and time trends

```{r, eval=(my_subset$family[[1]]=="Employment"), echo = FALSE, fig.height = 13, fig.width=6, message = FALSE, warning = FALSE, results = 'hide'}

library(sjlabelled)
library(foreach)

df <- my_data

df_twork <- df %>% dplyr::group_by(as_character(spend_hrs)) %>% dplyr::summarise(counts = n())
colnames(df_twork) <- c("Hours","counts")
df_twork$obs <- nrow(df)
df_twork$perc <- round(df_twork$counts/df_twork$obs,3)*100
#df_twork$Hours[is.na(df_twork$Hours)]<-"Refused" # 0702 data: 1 .r
df_twork$Hours=factor(df_twork$Hours,levels=c("Refused","No hours","Fewer","Same","More"))
rownames(df_twork) <-NULL

p_twork <- ggplot(df_twork, aes(x=Hours,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, hjust = -0.2) + coord_flip()+
  ylab("% of Respondents") + xlab("How many hours compared to before") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold")) +
  ggtitle("Over the past 7 days, how much time \n have you worked compared to a typical week before?")

df_earnings <- df %>% dplyr::group_by(as_character(earnings)) %>% dplyr::summarise(counts = n())
colnames(df_earnings) <- c("Earnings","counts")
df_earnings$obs <- nrow(df)
df_earnings$perc <- round(df_earnings$counts/df_earnings$obs,3)*100
#df_earnings$Earnings[is.na(df_earnings$Earnings)]<-"NAs (don't know/refused)" # 0702 data: 1 .r
df_earnings$Earnings=factor(df_earnings$Earnings,levels=df_earnings$Earnings[order(df_earnings$counts)])
rownames(df_earnings) <-NULL

p_earnings <- ggplot(df_earnings, aes(x=Earnings,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, hjust = -0.2) + coord_flip()+
  ylab("% of Respondents") + xlab("How much earnings compared to before") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold")) +
ggtitle("Over the past 7 days, how much are your \n earnings compared to a typical week before?")

df_effwage <- df %>% dplyr::group_by(as_character(corona_eff)) %>% dplyr::summarise(counts = n())
colnames(df_effwage) <- c("levels","counts")
df_effwage$obs <- nrow(df)
df_effwage$perc <- round(df_effwage$counts/df_effwage$obs,3)*100
df_effwage$levels=factor(df_effwage$levels,levels=c("Don't know","Not at all concerned","Not very concerned","Somewhat concerned","Very concerned"))
rownames(df_effwage) <-NULL
p_effwage <- ggplot(df_effwage, aes(x=levels,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, hjust = -0.2) + coord_flip()+
  ylab("% of Respondents") + xlab("Concerned about impact on income?") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold")) +
ggtitle("How concerned are you about the possible \n effects of Coronavirus on your household income?")

exp30 <- df %>% dplyr::select(starts_with("exp_30days_"))  %>% names  # get varnames of suspect questions
df_exp30 <- data.frame(
  question = get_label(df[,exp30]),
  foreach(i=exp30,.combine="rbind") %do%{
  eachqs = df[,i]
  obs = nrow(eachqs %>% drop_na())
  yes = sum(eachqs==1)
  no = sum(eachqs==0)
  perc = round(yes/obs,3)*100
  c("observations" = obs,"Yes-1" = yes,"No-0"=no,"Perc."=perc)
},
  stringsAsFactors = FALSE)
df_exp30$question[8] <- "Reduction in non-pecuniary benefits"  # shorten option entry

rownames(df_exp30) <- NULL

df_exp30$question=factor(df_exp30$question, levels = df_exp30$question[order(df_exp30$Perc.)])

p_exp30 <- ggplot(data = df_exp30,aes(x=question,y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() +
  geom_text(aes(label=Perc.),size=3, hjust = -0.2) +
  ylab("% of Respondents") + xlab("Option") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold")) +
ggtitle("In the last 30 days, have you experienced...?")


grid.arrange(p_twork, p_earnings, p_effwage, p_exp30, nrow=4)


```

```{r, eval=(my_subset$family[[1]]=="Food security"), echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}

library(sjlabelled)
library(foreach)

df <- my_data

#which(colnames(df)=='ask_help') #123
#which(colnames(df)=='without_eat') #126
svdays <- df[,c(which(colnames(df)=='ask_help'):which(colnames(df)=='without_eat'))]  %>% names 
df_svdays <-  data.frame(
  option = c("Asked help","Received help","Eaten fewer","Gone without food"),
  foreach(i=svdays,.combine="rbind") %do%{
  eachqs = df[,i]
  obs = nrow(eachqs)
  zero = round(sum(eachqs==0,na.rm = TRUE)/obs,3)*100
  one = round(sum(eachqs==1,na.rm = TRUE)/obs,3)*100
  two = round(sum(eachqs==2,na.rm = TRUE)/obs,3)*100
  three =round(sum(eachqs==3,na.rm = TRUE)/obs,3)*100
  four = round(sum(eachqs==4,na.rm = TRUE)/obs,3)*100
  five = round(sum(eachqs==5,na.rm = TRUE)/obs,3)*100
  six = round(sum(eachqs==6,na.rm = TRUE)/obs,3)*100
  seven = round(sum(eachqs==7,na.rm = TRUE)/obs,3)*100
  c("obs." = obs,"Zero"=zero,"One"=one,"Two"=two,"Three"=three,"Four"=four,"Five"=five,"Six"=six,"Seven"=seven)
},
stringsAsFactors = FALSE)
rownames(df_svdays) <- NULL

ask_help <- data.frame(t(df_svdays[1,3:10]))
ask_help <- setNames(cbind(rownames(ask_help), ask_help, row.names = NULL), 
         c("Level", "Perc."))
ask_help$Level=factor(ask_help$Level,levels=c("Seven","Six","Five","Four","Three","Two","One","Zero"))
p_ask_help <- ggplot(data=ask_help,aes(x=Level, y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() + ylim(0, 100) +
  geom_text(aes(label=Perc.),size=3, hjust = -0.2) +
  labs(y="% of Respondents",x="Level",title='Asked for help') +
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"))

rec_help <- data.frame(t(df_svdays[2,3:10]))
rec_help <- setNames(cbind(rownames(rec_help), rec_help, row.names = NULL), 
         c("Level", "Perc."))
rec_help$Level=factor(rec_help$Level,levels=c("Seven","Six","Five","Four","Three","Two","One","Zero"))
p_rec_help <- ggplot(data=rec_help,aes(x=Level, y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() + ylim(0, 100) +
  geom_text(aes(label=Perc.),size=3, hjust = -0.2) +
  labs(y="% of Respondents",x="Level",title='Received help') +
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"))

eat_few <- data.frame(t(df_svdays[3,3:10]))
eat_few <- setNames(cbind(rownames(eat_few), eat_few, row.names = NULL), 
         c("Level", "Perc."))
eat_few$Level=factor(eat_few$Level,levels=c("Seven","Six","Five","Four","Three","Two","One","Zero"))
p_eat_few <- ggplot(data=eat_few,aes(x=Level, y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() + ylim(0, 100) +
  geom_text(aes(label=Perc.),size=3, hjust = -0.2) +
  labs(y="% of Respondents",x="Level",title='Eaten fewer') +
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"))

no_eat <- data.frame(t(df_svdays[4,3:10]))
no_eat <- setNames(cbind(rownames(no_eat), no_eat, row.names = NULL), 
         c("Level", "Perc."))
no_eat$Level=factor(no_eat$Level,levels=c("Seven","Six","Five","Four","Three","Two","One","Zero"))
p_no_eat <- ggplot(data=no_eat,aes(x=Level, y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() + ylim(0, 100) +
  geom_text(aes(label=Perc.),size=3, hjust = -0.2) +
  labs(y="% of Respondents",x="Level",title='Gone without eating') +
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"))

df_mob <- df %>% dplyr::group_by(as_character(mob_restr)) %>% dplyr::summarise(counts = n())
colnames(df_mob) <- c("Difficulty","counts")
df_mob$obs <- nrow(df)-sum(is.na(df$mob_restr))
df_mob$perc <- round(df_mob$counts/df_mob$obs,3)*100
df_mob$Difficulty=factor(df_mob$Difficulty, levels = c("Refused","Yes","No"))
rownames(df_mob) <-NULL

p_mob <- ggplot(df_mob, aes(x=Difficulty,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, vjust = -0.2) +
  ylab("% of Respondents") + xlab("Difficulty in buying food") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"))

mobdif <- df %>% dplyr::select(starts_with("reason_ntbuy_"))  %>% names  # get varnames of questions
df_mobdif <- data.frame(
  question = get_label(df[,mobdif]),
  foreach(i=mobdif,.combine="rbind") %do%{
  eachqs = df[,i]
  obs = df_mob$counts[df_mob$Difficulty=="Yes"]
  yes = sum(eachqs==1, na.rm = TRUE)
  no = sum(eachqs==0, na.rm= TRUE)
  perc = round(yes/obs,3)*100
  c("observations" = obs,"Yes-1" = yes,"No-0"=no,"Perc."=perc)
},
  stringsAsFactors = FALSE)

df_mobdif$question[df_mobdif$question=="Other Specify"] <- "other (e.g. unemployed, shops closed))"
#df_mobdif <- rbind(df_mobdif,c("No difficultyy",nrow(df),df_mob$counts[df_mob$Difficulty=="No"],df_mob$counts[df_mob$Difficulty=="Yes"],round(df_mob$counts[df_mob$Difficulty=="No"]/nrow(df),3)*100))
#df_mobdif$Perc. <- as.numeric(df_mobdif$Perc.)

df_mobdif$question <- df_mobdif$question %>% str_replace_all(c( "Because of " = "", "Due to " = "","Because " = "","Specify"="Specifyy")) %>% substr(1,nchar(.)-1) %>% Hmisc::capitalize() # clean variable 

rownames(df_mobdif) <- NULL

df_mobdif$question=factor(df_mobdif$question, levels = df_mobdif$question[order(df_mobdif$Perc.)])
p_mobdif <- ggplot(data = df_mobdif,aes(x=question,y=Perc.)) + 
  geom_bar(stat = 'identity') +
  coord_flip() +
  geom_text(aes(label=Perc.),size=4, hjust = -0.2) +
  ylab("% of Respondents") + xlab("") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black",size=11), axis.text.y = element_text(colour="black",size=11))

grid.arrange(p_ask_help,p_rec_help,p_eat_few,p_no_eat,p_mob, p_mobdif, nrow=6)



```

```{r, eval=(my_subset$family[[1]]=="Economic situation"), echo = FALSE, fig.height = 10, fig.width=8, message = FALSE, warning = FALSE, results = 'hide'}

library(sjlabelled)
library(foreach)

df <- my_data

df_ownbs <- df %>% dplyr::group_by(as_character(own_bus)) %>% dplyr::summarise(counts = n())
colnames(df_ownbs) <- c("Own Business","counts")
df_ownbs$obs <- nrow(df)
df_ownbs$perc <- round(df_ownbs$counts/df_ownbs$obs,3)*100
# df_ownbs$`Own Business`[is.na(df_ownbs$`Own Business`)]<-"Refused" # 0706 data: 1 .r
rownames(df_ownbs) <-NULL
df_ownbs$`Own Business`=factor(df_ownbs$`Own Business`,levels=c("Yes","No","Refused"))

p_ownbsn <- ggplot(df_ownbs, aes(x=`Own Business`,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, vjust = -0.2) +
  ylab("% of Respondents") + xlab("Own business before shut school?") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold"))+
  ggtitle("Did you run your own business \n at the time government closed schools in March?")

df_stillown <- df %>% dplyr::group_by(as_character(still_own_bus)) %>% dplyr::summarise(counts = n())
colnames(df_stillown) <- c("Still Operational","counts")
df_stillown$obs <- nrow(df)
df_stillown$perc <- round(df_stillown$counts/df_stillown$obs,3)*100
df_stillown$`Still Operational`[is.na(df_stillown$`Still Operational`)] <- "Didn't own business/NA" # rename those who skipped  
rownames(df_stillown) <-NULL
df_stillown$`Still Operational`=factor(df_stillown$`Still Operational`,levels=c("Yes","No","Didn't own business/NA"))

p_stillown <- ggplot(df_stillown, aes(x=`Still Operational`,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, vjust = -0.2) +
  ylab("% of Respondents") + xlab("Business still operaitonal?") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold"))+
  ggtitle("Is the business currently operational?")

df_stbs <- df %>% dplyr::group_by(as_character(bus_start_lckdwn)) %>% dplyr::summarise(counts = n())
colnames(df_stbs) <- c("Start Business","counts")
df_stbs$obs <- nrow(df)
df_stbs$perc <- round(df_stbs$counts/df_stbs$obs,3)*100
df_stbs$`Start Business`[is.na(df_stbs$`Start Business`)]<- "NA (already own bsns/refused/dk)"  #remove 778 NAs
rownames(df_stbs) <-NULL
df_stbs$`Start Business`=factor(df_stbs$`Start Business`,levels=c("Yes","No","NA (already own bsns/refused/dk)"))

p_stbsn <- ggplot(df_stbs, aes(x=`Start Business`,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, vjust = -0.2) +
  ylab("% of Respondents") + xlab("Start business after shut school?") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold"))+
  ggtitle("Have you started a new business \n since the governemnt shut down since March?")


bsnpol <- df %>% dplyr::group_by(as_character(bus_sup)) %>% dplyr::summarise(counts = n())
colnames(bsnpol) <- c("Support_Policy","counts")
bsnpol$obs <- nrow(df)
bsnpol$perc <- round(bsnpol$counts/bsnpol$obs,3)*100
bsnpol$Support_Policy[is.na(bsnpol$Support_Policy)] <- "NA (not own bsns/refused/dk)" # 0702 data: 
rownames(bsnpol) <-NULL
bsnpol$Support_Policy=factor(bsnpol$Support_Policy, levels = bsnpol$Support_Policy[order(bsnpol$perc)])

p_bsnpol <- ggplot(bsnpol, aes(x=Support_Policy,y=perc)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=perc),size=3, hjust = -0.2) + coord_flip()+
  ylab("% of Respondents") + xlab("Best support policy for businessses") + ylim(0,100)+
  theme(axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"), 
        plot.title = element_text(size = 10, face = "bold"))+
  ggtitle("What would be the most needed policy \n to support your business over the COVID-19 crisis? ")

grid.arrange(p_ownbsn, p_stillown, p_stbsn, p_bsnpol, nrow=4) 

```

```{r, eval=(my_subset$family[[1]]=="Policy evaluation"), echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=4)
```

```{r, eval=(my_subset$family[[1]]=="Psychological well-being"), echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=3)
```

```{r, eval=(my_subset$family[[1]]=="Knowledge about disease"), echo = FALSE, fig.height = nrow(my_subset)*1.42 + 1, message = FALSE, warning = FALSE, results = 'hide'}
dashdash:::all_bar_plot(my_data, my_subset, nrow=2)
```

### Current averages

```{r, echo = FALSE, message = FALSE}

current_means <- get_current_means(my_data, my_subset, recent = 1)

kable(current_means, caption = paste("Mean responses in each ", group, " (most recent date)"), 
        col.names = c(group, "Date", my_subset$short_label), 
        digits = 2)

```


<!-- Optionally add maps -->

```{r, child = add_mapsRmd, echo = FALSE, eval = add_maps}

```


### Definitions of measures

```{r, echo = FALSE, warning = FALSE}

if("min" %in% colnames(my_subset) & "max" %in% colnames(my_subset))
{
  my_subset %>% mutate(range = paste(as.character(min), "-", as.character(max))) %>%
    select(short_label, description, range, scale) %>% 
   kable(caption = "Data definitions", col.names = c("Measure", "Definition", "Range", "Response options"))
}else {
  my_subset %>% select(short_label, description) %>% 
  kable(caption = "Data definitions", col.names = c("Measure", "Definition"))
  }

```

```{r, include = FALSE}
k <- k+1
```

```{r, child = childRmd, echo = FALSE, eval = k <= n_families}

```
