---
title: "child"
author: "sl team"
date: "4/26/2020"
output: html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)

fam <- families[k]

```


## `r gsub("_", " ", fam)`  {.tabset  .tabset-pills}


```{r}

vars <- my_vars %>% filter(family == fam & !is.na(variable)) %>% pull(variable)
var_labs <- my_vars %>% filter(family == fam & !is.na(variable)) %>% pull(short_label)
names(var_labs) <- vars

current_means <- my_data[, c("id", "date", vars)] %>%
 filter(date == max(date)) %>%
 group_by(id, date)  %>%
 summarise_all( function(x)  mean(x, na.rm = T)) 
```

### Time trends

#### National aggregates

```{r, echo = FALSE, fig.cap="Average responses for a given day (dot) with 95% confidence intervals (whiskers)", message = FALSE, warning = FALSE}

# New facet label names for supp variable
  my_data %>% 
    
    select(all_of(c("date", vars))) %>%
    reshape2::melt(id.vars= c("date"))  %>% 
    group_by(date, variable) %>%
    summarise_all(list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE), ~length(.))) %>%
    mutate(se = sd / sqrt(length)) %>%
    
    ggplot(aes(x=date, y=mean)) + 
    geom_errorbar(aes(ymin=mean-1.96*se, ymax=mean+1.96*se), width=.1, position=pd) +
    geom_line(position=pd) +
    geom_point(position=pd) +
    facet_wrap(~variable, scales = "free_y", 
               labeller = labeller(variable = var_labs), 
               strip.position = "top") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

#### Broken down by `r group`


```{r, echo = FALSE, fig.cap="Disaggregated average responses for a given day (dot) with 95% confidence intervals (whiskers)", fig.height = length(vars)*1.42 + 1, fig.width = (unique(my_data$id) %>% length)*1.1, message = FALSE, warning = FALSE}

# New facet label names for supp variable
  my_data %>% 
    
    select(all_of(c("id", "date", vars))) %>%
    reshape2::melt(id.vars= c("id", "date"))  %>% 
    group_by(id, date, variable) %>%
    summarise_all(list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE), ~length(.))) %>%
    mutate(se = sd / sqrt(length)) %>%
    
    ggplot(aes(x=date, y=mean)) + 
    geom_errorbar(aes(ymin=mean-1.96*se, ymax=mean+1.96*se), width=.1, position=pd) +
    geom_line(position=pd) +
    geom_point(position=pd) +
    facet_grid(variable ~ id, scales = "free_y", 
               labeller = labeller(variable = var_labs), 
               switch = switch) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


<!-- Optionally add maps -->

```{r, child = add_mapsRmd, echo = FALSE, eval = add_maps}

```


### Current averages

```{r, echo = FALSE}

current_means %>% 
  
 kable(caption = paste("Mean responses in each ", group, " (most recent date)"), 
       col.names = c(group, "Date", var_labs), 
       digits = 2)

```

### Definitions of measures

```{r, echo = FALSE, warning = FALSE}

my_vars %>% 
  filter(family == fam) %>% select(short_label, description) %>% 
  kable(caption = "Data definitions", col.names = c("Measure", "Definition"))

```

```{r, include = FALSE}
k <- k+1
```

```{r, child = childRmd, echo = FALSE, eval = k <= n_families}

```
