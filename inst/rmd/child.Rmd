---
title: "child"
author: "sl team"
date: "4/26/2020"
output: html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
fam <- families[k]

```


## `r gsub("_", " ", fam)`  {.tabset  .tabset-pills}


```{r}

vars <- my_vars %>% filter(family == fam & !is.na(variable)) %>% pull(variable)
var_labs <- my_vars %>% filter(family == fam & !is.na(variable)) %>% pull(short_label)
names(var_labs) <- vars
my_vars <- my_vars


```

### Time trends

#### National aggregates

```{r, echo = FALSE, fig.cap="Average responses for a given day (dot) with 95% confidence intervals (whiskers)", message = FALSE, warning = FALSE}

plot_aggregates(my_data, my_vars, vars, var_labs, pd = pd)

```

#### Broken down by `r group`


```{r, echo = FALSE, fig.cap="Disaggregated average responses for a given day (dot) with 95% confidence intervals (whiskers)", fig.height = length(vars)*1.42 + 1, fig.width = (unique(my_data$id) %>% length)*1.1, message = FALSE, warning = FALSE}

# New facet label names for supp variable
low_level <- my_data %>% 
  select(all_of(c("id", "date", vars))) %>%
  reshape2::melt(id.vars= c("id", "date"))  %>% 
  group_by(id, date, variable) %>%
  summarise_all(list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE), ~length(.))) %>%
  mutate(se = sd / sqrt(length),
         ymin=mean-1.96*se, 
         ymax=mean+1.96*se) 

if (!is.null(my_vars$min) & !is.null(my_vars$max)){
    
    datalist <-  list()
    
    for (index in vars) {
        selection <- filter(my_vars, variable == index) %>%
            select(variable, min, max)
        ids <- droplevels(my_data$id) %>%
            levels()
        grid <- expand.grid(variable = selection$variable,
                            id = ids,
                            date = c(min(my_data$date), max(my_data$date)), 
                            min = selection$min,
                            max = selection$max)
        datalist[[index]] <- grid
        
    }
    
    ranges <- do.call(rbind, datalist)
    
    low_level <- left_join(low_level, ranges)  %>%
    mutate( 
           floor = min-1.96*se,
           ceiling = max+1.96*se)
    
}

plot <- ggplot(low_level, aes(x=date, y=mean)) + 
    geom_point(position=pd) +
    geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1, position=pd) +
    geom_line(position=pd) +
    facet_grid(variable ~ id, scales = "free_y", 
               labeller = labeller(variable = var_labs), 
               switch = switch) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

if (!is.null(my_vars$min) & !is.null(my_vars$max)){
plot + geom_blank(aes(x=date, y=ceiling)) + 
    geom_blank(aes(x=date, y=floor))
}

plot
    


```



### Current averages

```{r, echo = FALSE}

current_means <- my_data[, c("id", "date", vars)] %>%
 filter(date == max(date)) %>%
 group_by(id, date)  %>%
 summarise_all( function(x)  mean(x, na.rm = T)) 

current_means %>% 
  
 kable(caption = paste("Mean responses in each ", group, " (most recent date)"), 
       col.names = c(group, "Date", var_labs), 
       digits = 2)

```


<!-- Optionally add maps -->

```{r, child = add_mapsRmd, echo = FALSE, eval = add_maps}

```


### Definitions of measures

```{r, echo = FALSE, warning = FALSE}

my_vars %>% 
  filter(family == fam) %>% select(short_label, description) %>% 
  kable(caption = "Data definitions", col.names = c("Measure", "Definition"))

```

```{r, include = FALSE}
k <- k+1
```

```{r, child = childRmd, echo = FALSE, eval = k <= n_families}

```
